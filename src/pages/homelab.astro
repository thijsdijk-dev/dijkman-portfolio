---
import Base from "../layouts/Base.astro";
import CodeBlock from "../components/tech/CodeBlock.astro";
import TechLayout from "../components/tech/TechLayout.astro";
import Hero from "../components/tech/Hero.astro";
import StatGrid from "../components/tech/StatGrid.astro";
import Section from "../components/tech/Section.astro";
import Card from "../components/tech/Card.astro";
import Callout from "../components/tech/Callout.astro";
import Steps from "../components/tech/Steps.astro";
import Roadmap from "../components/tech/Roadmap.astro";
import Diagram from "../components/tech/Diagram.astro";

const toc = [
  { id: "overview", label: "Overzicht" },
  { id: "network", label: "Netwerk & routing" },
  { id: "docker", label: "Docker & containers" },
  { id: "reverse-proxy", label: "Reverse proxy & TLS" },
  { id: "deploy", label: "CI/CD deploy" },
  { id: "security", label: "Security" },
  { id: "ops", label: "Beheer & monitoring" },
  { id: "roadmap", label: "Roadmap" },
];

const hero = {
  title: "Homelab",
  subtitle:
    "Self-hosted Raspberry Pi homelab: Docker services, reverse proxy, DNS-01 TLS en automatische deploy.",
  facts: [
    { label: "Host", value: "Raspberry Pi · Debian (ARM64)" },
    { label: "Ingress", value: "80/443 → Nginx Proxy Manager" },
    { label: "DNS", value: "TransIP (A/CNAME + DNS-01 challenges)" },
    { label: "Deploy", value: "GitHub Actions → SSH → update dist" },
  ],
};

const stats = [
  { label: "Publieke poorten", value: "80 + 443" },
  { label: "Reverse proxy", value: "NPM (openresty/nginx)" },
  { label: "Portfolio container", value: "nginx:alpine (static dist)" },
  { label: "Certs", value: "Let’s Encrypt (DNS-01)" },
];
---

<TechLayout title="Homelab" toc={toc}>
  <Hero title={hero.title} subtitle={hero.subtitle} facts={hero.facts} />

  <StatGrid items={stats} />

  <Section id="overview" title="Overzicht">
    <Card>
      <p>
        Mijn website draait op een eigen Raspberry Pi server. Publieke traffic komt binnen op <code>80/443</code>,
        wordt door Nginx Proxy Manager gerouteerd naar interne containers, en TLS wordt afgehandeld met Let’s Encrypt
        via <strong>DNS-01</strong> (TransIP).
      </p>
    </Card>

    <Callout kind="success" title="Status">
      De site is extern bereikbaar en subpagina’s werken via static routing (index.html per route).
    </Callout>
  </Section>

  <Section id="network" title="Netwerk & routing">
    <Diagram
      title="Traffic flow"
      content={`Browser → DNS (TransIP) → Public IP (Ziggo) → Router port forward (80/443) → RPi (Docker) → NPM → portfolio container`}
    />

    <div class="grid">
      <Card title="DNS records">
        <ul>
          <li><code>A</code> record: <code>dijkman.dev → &lt;public IP&gt;</code></li>
          <li><code>CNAME</code> record: <code>www → dijkman.dev</code> (optioneel)</li>
        </ul>
      </Card>

      <Card title="Port forwarding">
        <ul>
          <li>Forward <code>TCP 80</code> → Raspberry Pi LAN IP</li>
          <li>Forward <code>TCP 443</code> → Raspberry Pi LAN IP</li>
        </ul>
      </Card>
    </div>
  </Section>

  <Section id="docker" title="Docker & containers">
    <div class="grid">
      <Card title="Core containers">
        <ul>
          <li><strong>Nginx Proxy Manager</strong> (ingress + TLS)</li>
          <li><strong>portfolio</strong> (nginx static: dist)</li>
          <li><strong>portainer</strong> (beheer)</li>
          <li><strong>whoami</strong> (debug / connectivity test)</li>
        </ul>
      </Card>

      <Card title="Netwerk model">
        <p>
          Containers hangen op een gedeeld docker network (<code>proxy</code>) zodat NPM intern kan routen
          naar <code>portfolio:80</code> zonder host-ports open te zetten.
        </p>
      </Card>
    </div>

    <Callout kind="info" title="Waarom static nginx container?">
      Astro build output is een <code>dist</code> map → snel, simpel, weinig attack surface.
    </Callout>
  </Section>

  <Section id="reverse-proxy" title="Reverse proxy & TLS">
    <Steps
      title="Wat er draait"
      items={[
        "NPM luistert op 80/443 op de host (docker-proxy)",
        "Proxy host rule: dijkman.dev → portfolio:80",
        "Let’s Encrypt DNS-01 via TransIP plugin",
        "www redirect: www.dijkman.dev → dijkman.dev (optioneel via host/redirect rule)",
      ]}
    />

    <Callout kind="warning" title="Let’s Encrypt rate limits">
      Als je veel certs aanvraagt/verwijdert, kun je tijdelijk geblokkeerd worden. Gebruik liever één certificaat voor apex + wildcard.
    </Callout>
  </Section>

  <Section id="deploy" title="CI/CD deploy">
    <Card title="Deploy-strategie (simpel & robuust)">
      <ol>
        <li>Build Astro op je PC (of in GitHub Actions)</li>
        <li>Upload <code>dist/</code> naar de Pi (scp/rsync)</li>
        <li>Fix permissions (directories 755, files 644)</li>
        <li>Restart (of reload) portfolio container</li>
      </ol>
    </Card>

    <Callout kind="info" title="Jij hebt dit al bewezen in de praktijk">
      Je 403 kwam door permissies/mount-path; na chmod + juiste mount werkte routing weer.
    </Callout>
  </Section>

  <Section id="security" title="Security">
    <div class="grid">
      <Card title="Ingress beperken">
        Alleen 80/443 publiek. Services blijven intern achter de reverse proxy.
      </Card>
      <Card title="SSH key-only">
        GitHub Actions deploy key is separaat, beperkt en zonder password login.
      </Card>
      <Card title="TLS correctheid">
        Cert SAN moet matchen met hostnames (apex + eventueel wildcard).
      </Card>
      <Card title="Hardening ideeën">
        Fail2ban, SSH rate limiting, automatische updates, backups.
      </Card>
    </div>
  </Section>

  <Section id="ops" title="Beheer & monitoring">
    <div class="grid">
      <Card title="Logging">
        NPM logs + container logs → troubleshooting (403/404/SSL).
      </Card>
      <Card title="Monitoring (Uptime Kuma)">
        <p>
          Externe uptime checks en notificaties draaien nu via Uptime Kuma op
          <a href="https://status.dijkman.dev/" target="_blank" rel="noreferrer">status.dijkman.dev</a>.
        </p>
        <p>
          <a href="https://status.dijkman.dev/" target="_blank" rel="noreferrer">
            <img
              src="https://status.dijkman.dev/api/badge/1/status?upColor=%2344cc11&downColor=%23ff3366&pendingColor=%23ffaa00&maintenanceColor=%238ea6ff"
              alt="Uptime Kuma status badge"
              loading="lazy"
            />
          </a>
        </p>
      </Card>
      <Card title="Backups">
        NPM data + site dist worden nu automatisch geback-upt naar externe storage (USB) via cron.
      </Card>
      <Card title="Updates">
        Deploy updates lopen via GitHub Actions; wijzigingen op main worden automatisch naar de Pi uitgerold.
      </Card>
      <Card title="Documentatie">
        “Living documentation” op deze pagina: wat draait, waarom, hoe.
      </Card>
    </div>
  </Section>

  <Section id="roadmap" title="Roadmap">
    <Roadmap
      items={[
        { text: "Uptime Kuma toegevoegd + status badge op /homelab", done: true },
        { text: "Backups: NPM data + dist + compose naar externe storage", done: true },
        { text: "Fail2ban + sshd hardening + firewall (ufw) baseline", done: false },
        { text: "Infra repo: docker-compose.yml + README met recovery steps", done: false },
      ]}
    />
  </Section>
</TechLayout>

<style>
  .grid{
    display:grid;
    gap:14px;
    grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  }
  ul{ margin:0; padding-left:18px; }
  code{ padding:2px 6px; border-radius:8px; background:#111; }
</style>
