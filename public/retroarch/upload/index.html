<!doctype html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RetroArch ROM Uploader</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #0f1115;
        --card: #151924;
        --border: #2a3040;
        --text: #f5f7ff;
        --muted: #b4bed3;
        --accent: #6ea8ff;
        --success: #39d98a;
        --danger: #ff6b7a;
      }
      body { font-family: Inter, system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
      main { max-width: 940px; margin: 0 auto; padding: 28px 18px 50px; }
      h1 { margin: 0 0 10px; }
      .muted { color: var(--muted); }
      section { margin-top: 24px; padding: 18px; border: 1px solid var(--border); border-radius: 14px; background: var(--card); }
      .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      input[type="text"] { min-width: 280px; width: 420px; max-width: 100%; padding: 9px 11px; border-radius: 10px; border: 1px solid var(--border); background: #0d1017; color: var(--text); }
      button { padding: 9px 12px; border-radius: 10px; border: 1px solid #3a4356; background: #161d2b; color: var(--text); cursor: pointer; }
      button:hover { border-color: #5b6b8d; }
      code { background: #0d1017; border: 1px solid var(--border); padding: 1px 6px; border-radius: 8px; }
      .ok { color: var(--success); }
      .err { color: var(--danger); white-space: pre-wrap; }
      table { width: 100%; border-collapse: collapse; margin-top: 12px; }
      th, td { border-bottom: 1px solid var(--border); text-align: left; padding: 10px 6px; }
      .small { font-size: .9rem; }
      a { color: var(--accent); }
    </style>
  </head>
  <body>
    <main>
      <h1>RetroArch ROM Uploader</h1>
      <p class="muted">
        Upload naar <code>/retroarch/roms/</code>. API endpoint wordt automatisch gevonden
        (<code>/retroarch/upload/api</code>, <code>/retroarch/api</code>, <code>/api</code>).
      </p>

      <section>
        <h2>1) Upload token</h2>
        <div class="row">
          <input id="token" type="text" placeholder="Plak hier je upload token" />
          <button id="saveToken">Opslaan</button>
          <button id="clearToken">Wissen</button>
          <span id="tokenMsg" class="muted"></span>
        </div>
      </section>

      <section>
        <h2>2) Upload ROM</h2>
        <div class="row">
          <input id="file" type="file" />
          <button id="upload">Upload</button>
          <span class="muted small">Max bestandsgrootte hangt af van je serverinstellingen.</span>
        </div>
        <p id="uploadMsg" class="muted"></p>
      </section>

      <section>
        <h2>3) ROMs op server</h2>
        <button id="refresh">Verversen</button>
        <p id="listMsg" class="muted"></p>
        <table>
          <thead>
            <tr><th>Bestand</th><th>Grootte</th><th>Download</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </section>
    </main>

    <script>
      const TOKEN_KEY = 'retroarch_upload_token';
      const tokenEl = document.getElementById('token');
      const tokenMsg = document.getElementById('tokenMsg');
      const uploadMsg = document.getElementById('uploadMsg');
      const listMsg = document.getElementById('listMsg');
      const rowsEl = document.getElementById('rows');

      const API_BASES = ['/retroarch/upload/api', '/retroarch/api', '/api'];
      let cachedBase = null;

      const setMsg = (el, text, cls = 'muted') => {
        el.className = cls;
        el.textContent = text;
      };

      const token = () => tokenEl.value.trim();

      const jsonOrThrow = async (res) => {
        const text = await res.text();
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}\n${text.slice(0, 600)}`);
        }
        try {
          return JSON.parse(text || '{}');
        } catch {
          throw new Error(`Invalid JSON response\n${text.slice(0, 600)}`);
        }
      };

      async function requestAny(path, init = {}) {
        const bases = cachedBase ? [cachedBase, ...API_BASES.filter((b) => b !== cachedBase)] : API_BASES;
        let lastErr = null;

        for (const base of bases) {
          try {
            const res = await fetch(`${base}${path}`, init);
            const contentType = res.headers.get('content-type') || '';
            if (res.status === 404 || res.status === 405 || contentType.includes('text/html')) {
              throw new Error(`Base ${base} rejected (${res.status})`);
            }
            cachedBase = base;
            return { base, res };
          } catch (err) {
            lastErr = err;
          }
        }
        throw lastErr || new Error('Geen werkende API-base gevonden.');
      }

      document.getElementById('saveToken').onclick = () => {
        localStorage.setItem(TOKEN_KEY, token());
        setMsg(tokenMsg, 'Token staat opgeslagen.', 'ok');
      };

      document.getElementById('clearToken').onclick = () => {
        localStorage.removeItem(TOKEN_KEY);
        tokenEl.value = '';
        setMsg(tokenMsg, 'Token gewist.', 'muted');
      };

      async function refreshList() {
        setMsg(listMsg, 'Lijst laden…', 'muted');
        rowsEl.innerHTML = '';
        try {
          const { base, res } = await requestAny('/files');
          const data = await jsonOrThrow(res);
          const files = data.files || [];
          if (!files.length) {
            setMsg(listMsg, `Geen bestanden gevonden (API: ${base}).`, 'muted');
            return;
          }
          setMsg(listMsg, `${files.length} bestand(en) gevonden via ${base}.`, 'ok');
          for (const file of files) {
            const tr = document.createElement('tr');
            const name = file.name || file.filename || '(onbekend)';
            const size = file.size ? `${(file.size / (1024 * 1024)).toFixed(2)} MB` : '-';
            const dl = `${base}/download/${encodeURIComponent(name)}`;
            tr.innerHTML = `<td>${name}</td><td>${size}</td><td><a href="${dl}" target="_blank" rel="noreferrer">Download</a></td>`;
            rowsEl.appendChild(tr);
          }
        } catch (err) {
          setMsg(listMsg, `Kon lijst niet laden: ${err.message}`, 'err');
        }
      }

      document.getElementById('upload').onclick = async () => {
        const fileEl = document.getElementById('file');
        const file = fileEl.files && fileEl.files[0];
        if (!file) {
          setMsg(uploadMsg, 'Kies eerst een bestand.', 'err');
          return;
        }
        if (!token()) {
          setMsg(uploadMsg, 'Voeg eerst een upload token toe.', 'err');
          return;
        }

        const form = new FormData();
        form.append('file', file);
        setMsg(uploadMsg, `Uploaden van ${file.name}…`, 'muted');

        try {
          const { base, res } = await requestAny('/upload', {
            method: 'POST',
            headers: { 'X-Upload-Token': token() },
            body: form,
          });
          const data = await jsonOrThrow(res);
          setMsg(uploadMsg, `Upload gelukt via ${base}: ${data.filename || file.name}`, 'ok');
          await refreshList();
        } catch (err) {
          setMsg(uploadMsg, `Upload mislukt: ${err.message}`, 'err');
        }
      };

      document.getElementById('refresh').onclick = refreshList;

      (function init() {
        tokenEl.value = localStorage.getItem(TOKEN_KEY) || '';
        if (tokenEl.value) setMsg(tokenMsg, 'Token geladen uit browser-opslag.', 'ok');
        refreshList();
      })();
    </script>
  </body>
</html>
